<!DOCTYPE html>
<html>
<head>
    <title>VK Auth</title>
    <script src="https://unpkg.com/crypto-js@4.1.1/crypto-js.js"></script>
</head>
<body>
    <div id="auth-container">
        <h2>Авторизация VK</h2>
        <button onclick="startAuth()">Войти через VK ID</button>
    </div>

    <script>
        // Генерация code_verifier (43-128 символов)
        function generateCodeVerifier() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-';
            let result = '';
            for (let i = 0; i < 64; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Генерация code_challenge (SHA256 + Base64)
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(hash)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function startAuth() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const state = Math.random().toString(36).substring(7);

            // Сохраняем для последующего использования
            sessionStorage.setItem('code_verifier', codeVerifier);
            sessionStorage.setItem('state', state);

            // Формируем URL авторизации
            const authUrl = new URL('https://id.vk.com/authorize');
            authUrl.searchParams.append('client_id', '54235050');
            authUrl.searchParams.append('redirect_uri', 'https://azesmf.github.io/Secure-Ai-Architecture/vk-auth/');
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('scope', 'wall,photos,groups');
            authUrl.searchParams.append('state', state);
            authUrl.searchParams.append('code_challenge', codeChallenge);
            authUrl.searchParams.append('code_challenge_method', 'S256');

            window.location.href = authUrl.toString();
        }

        // Проверяем, есть ли code в URL (возврат из VK ID)
        function checkReturnFromVK() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            if (code && state) {
                const savedState = sessionStorage.getItem('state');
                if (state === savedState) {
                    const codeVerifier = sessionStorage.getItem('code_verifier');
                    exchangeCodeForToken(code, codeVerifier);
                }
            }
        }

        // Обмен code на token через Pipedream
        async function exchangeCodeForToken(code, codeVerifier) {
            try {
                const response = await fetch('ТВОЙ_PIPEDREAM_ENDPOINT', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        code_verifier: codeVerifier,
                        redirect_uri: 'https://azesmf.github.io/Secure-Ai-Architecture/vk-auth/'
                    })
                });

                const tokenData = await response.json();
                if (tokenData.access_token) {
                    document.getElementById('auth-container').innerHTML = 
                        `<h3>✅ Успех! Token получен</h3>
                         <p>Access Token: ${tokenData.access_token}</p>
                         <button onclick="copyToken()">Скопировать token</button>`;
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        // Запускаем проверку при загрузке страницы
        checkReturnFromVK();
    </script>
</body>
</html>