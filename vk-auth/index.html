<!DOCTYPE html>
<html>
<head>
    <title>VK Auth</title>
</head>
<body>
    <div id="auth-container">
        <h2>Авторизация VK</h2>
        <button onclick="startAuth()">Войти через VK ID</button>
    </div>

    <script>
        // Генерация code_verifier
        function generateCodeVerifier() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-';
            let result = '';
            for (let i = 0; i < 64; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Генерация code_challenge
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(hash)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function startAuth() {
            try {
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                const state = Math.random().toString(36).substring(7);

                sessionStorage.setItem('code_verifier', codeVerifier);
                sessionStorage.setItem('state', state);

                const authUrl = new URL('https://id.vk.com/authorize');
                authUrl.searchParams.append('client_id', '54235050');
                authUrl.searchParams.append('redirect_uri', 'https://azesmf.github.io/Secure-Ai-Architecture/vk-auth/');
                authUrl.searchParams.append('response_type', 'code');
                authUrl.searchParams.append('scope', 'wall,photos,groups');
                authUrl.searchParams.append('state', state);
                authUrl.searchParams.append('code_challenge', codeChallenge);
                authUrl.searchParams.append('code_challenge_method', 'S256');

                window.location.href = authUrl.toString();
            } catch (error) {
                console.error('Auth error:', error);
            }
        }

        // Проверяем возврат из VK ID
        function checkReturnFromVK() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                document.getElementById('auth-container').innerHTML = 
                    `<h3>❌ Ошибка VK ID</h3><p>${error}: ${urlParams.get('error_description')}</p>`;
                return;
            }

            if (code && state) {
                const savedState = sessionStorage.getItem('state');
                if (state === savedState) {
                    const codeVerifier = sessionStorage.getItem('code_verifier');
                    sendToWebhook(code, codeVerifier);
                }
            }
        }

        // Отправляем данные на webhook.site
        async function sendToWebhook(code, codeVerifier) {
            try {
                console.log('Sending data:', { code, codeVerifier });
                
                const response = await fetch('https://webhook.site/c07079d1-6249-4eaa-b3b8-dbee228bb8c2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        code_verifier: codeVerifier,
                        redirect_uri: 'https://azesmf.github.io/Secure-Ai-Architecture/vk-auth/',
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                document.getElementById('auth-container').innerHTML = 
                    `<h3>✅ Данные отправлены!</h3>
                     <p>Code: ${code}</p>
                     <p>Проверь webhook.site</p>`;
                     
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('auth-container').innerHTML = 
                    `<h3>❌ Ошибка отправки</h3>
                     <p>${error.message}</p>
                     <p>Code: ${code}</p>
                     <p>Code_verifier: ${codeVerifier}</p>`;
            }
        }

        // Запускаем при загрузке
        checkReturnFromVK();
    </script>
</body>
</html>